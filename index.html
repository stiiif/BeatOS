<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatOS - Granular Drum Machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/controls.css">
    <link rel="stylesheet" href="css/sequencer.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header / Transport Bar -->
    <header class="h-12 bg-neutral-900 border-b border-neutral-800 flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-emerald-500 font-bold text-lg"><i class="fas fa-cubes mr-2"></i>BEAT-OS</h1>
            <div class="h-6 w-px bg-neutral-700"></div>
            <button id="playBtn" class="text-neutral-400 hover:text-white transition w-8"><i class="fas fa-play text-lg"></i></button>
            <button id="stopBtn" class="text-neutral-400 hover:text-white transition w-8"><i class="fas fa-stop text-lg"></i></button>
            <div class="flex items-center gap-2 ml-2 bg-neutral-800 rounded px-2 py-1">
                <span class="text-xs text-neutral-500 font-bold">BPM</span>
                <input type="number" id="bpmInput" value="120" min="30" max="300" class="bg-transparent border-none w-12 text-sm text-center focus:outline-none text-emerald-400 font-mono">
            </div>
            <!-- Grain Monitor (Optional, can be componentized later) -->
            <div class="flex items-center gap-2 ml-2 bg-neutral-800 rounded px-2 py-1">
                <span class="text-xs text-neutral-500 font-bold"><i class="fas fa-microchip"></i> CPU</span>
                <span id="grainMonitor" class="text-sm font-mono text-emerald-400 w-8 text-center">0</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
             <button id="snapshotBtn" class="text-[10px] bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-2 py-1 rounded transition border border-neutral-700 w-16">Snap</button>
             <button id="rndChokeBtn" class="text-[10px] bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-2 py-1 rounded transition border border-neutral-700">Rnd Choke</button>
             <div class="h-6 w-px bg-neutral-700 mx-1"></div>
             
             <!-- Library Actions -->
             <button id="saveTrackBtn" class="text-[10px] bg-neutral-800 hover:bg-amber-900/30 text-amber-500 px-2 py-1 rounded transition border border-neutral-700" title="Save current track"><i class="fas fa-save mr-1"></i>Lib</button>
             <button id="loadTrackBtn" class="text-[10px] bg-neutral-800 hover:bg-amber-900/30 text-amber-500 px-2 py-1 rounded transition border border-neutral-700" title="Load track"><i class="fas fa-folder-open mr-1"></i>Lib</button>
             
             <input type="file" id="sampleInput" class="hidden" accept="audio/*">
             
             <div class="h-6 w-px bg-neutral-700 mx-1"></div>
             
             <!-- Global Project Actions -->
             <button id="saveBtn" class="text-[10px] bg-neutral-800 hover:bg-emerald-900/30 text-emerald-500 px-2 py-1 rounded transition border border-neutral-700" title="Save Project"><i class="fas fa-download"></i></button>
             <button id="loadBtn" class="text-[10px] bg-neutral-800 hover:bg-emerald-900/30 text-emerald-500 px-2 py-1 rounded transition border border-neutral-700" title="Load Project"><i class="fas fa-upload"></i></button>
             <input type="file" id="fileInput" class="hidden" accept=".json,.beatos,.zip">
        </div>
    </header>

    <div class="app-container">

        <!-- Left Panel: Modules (Groove, Pan, etc) -->
        <!-- We keep the structure but the logic is now handled by event bus listeners or simple inline scripts in App.js for now -->
        <div class="new-left-panel bg-[#0d0d0d] overflow-y-auto custom-scrollbar">
            <div class="p-4 space-y-6">
                <!-- Groove Generator Placeholder - Logic wired in App.js or future component -->
                <div id="grooveModule">
                    <!-- ... HTML from original ... -->
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-[10px] text-neutral-500 uppercase font-bold"><i class="fas fa-music mr-1"></i> Groove Generator</label>
                    </div>
                    <div class="bg-neutral-800/50 p-3 rounded border border-neutral-800 space-y-3">
                         <div class="space-y-2">
                             <select id="patternSelect" class="w-full bg-neutral-900 text-neutral-300 text-[10px] rounded border border-neutral-700 p-2 outline-none"></select>
                             <select id="targetGroupSelect" class="w-full bg-neutral-900 text-neutral-300 text-[10px] rounded border border-neutral-700 p-2 outline-none"></select>
                         </div>
                         <div class="flex items-center gap-2 bg-neutral-900/50 p-1.5 rounded border border-neutral-800">
                            <span class="text-[9px] text-neutral-500 font-bold whitespace-nowrap">RND %</span>
                            <input type="range" id="patternInfluence" min="0" max="100" value="100" class="flex-1 h-1 bg-neutral-700 rounded-lg appearance-none cursor-pointer">
                            <span id="patternInfluenceVal" class="text-[9px] text-emerald-400 font-mono w-6 text-right">100</span>
                        </div>
                        <button id="applyGrooveBtn" class="w-full text-[10px] bg-emerald-900/30 hover:bg-emerald-800 text-emerald-400 hover:text-white py-2 rounded transition border border-emerald-900/50 font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i> APPLY GROOVE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="resizer-v" id="resizer-left"></div>

        <!-- Middle Pane: Sequencer -->
        <div class="middle-pane">
            <div class="sequencer-panel relative custom-scrollbar">
                
                <!-- Start Overlay -->
                <div id="startOverlay" class="absolute inset-0 bg-neutral-950/95 z-50 flex flex-col items-center justify-center">
                    <button id="initAudioBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-10 rounded-full shadow-2xl shadow-emerald-900/50 transition transform hover:scale-105 border border-emerald-400">
                        <i class="fas fa-power-off mr-2"></i> INITIALIZE AUDIO
                    </button>
                </div>

                <div class="flex h-full">
                    <!-- Sequencer Component Mount Point -->
                    <div class="flex-1 flex flex-col min-w-0">
                        <div id="stepHeaders"></div> <!-- Populated by Sequencer.js -->
                        <div class="matrix-container" id="matrixContainer"></div> <!-- Populated by Sequencer.js -->
                        <div class="h-10"></div>
                    </div>
                    
                    <!-- Global Visualizer -->
                    <div class="w-16 bg-[#050505] border-l border-neutral-800 shrink-0 sticky right-0 top-0 h-full z-10">
                        <div class="h-[22px] border-b border-neutral-800 bg-neutral-950"></div>
                        <canvas id="visualizer" title="Click to select track" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="resizer-h"></div>
            
            <div class="future-panel custom-scrollbar">
                <div class="text-neutral-600 text-center">
                    <p>Arranger Area</p>
                </div>
            </div>
        </div>

        <div class="resizer-v" id="resizer-right"></div>

        <!-- Right Pane: Inspector -->
        <div class="right-pane border-l border-neutral-800 shadow-2xl">
            <!-- Header and contents managed by Inspector.js, binding to existing IDs -->
            
            <!-- Dynamic Header Area -->
            <div class="p-3 bg-neutral-800 border-b border-neutral-700 flex flex-col gap-2">
                <!-- Inspector.js will rebuild this via renderDynamicHeader, but we keep structure for ID binding -->
                <div class="flex items-center gap-2 w-full">
                    <span class="w-3 h-3 rounded-full" id="trackIndicator"></span>
                    <span id="currentTrackNum" class="text-sm font-bold text-white font-mono">00</span>
                    <span class="text-xs text-neutral-300 truncate flex-1 font-bold">Track 01</span>
                    <span id="trackTypeLabel" class="text-[10px] text-neutral-500 font-mono uppercase">[SYNTH]</span>
                </div>
                <!-- Dynamic buttons injected here -->
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-4 custom-scrollbar">
                
                <!-- Controls Areas (Toggled by Inspector.js) -->
                
                <!-- Granular Controls -->
                <div id="granularControls">
                    <div class="mb-4">
                        <canvas id="bufferDisplay" class="w-full h-20 bg-neutral-900 border border-neutral-800 rounded mb-2"></canvas>
                    </div>
                    
                    <!-- Sliders Example -->
                    <div class="grid grid-cols-4 gap-x-2 gap-y-4">
                        <div class="knob-container col-span-2">
                            <label class="text-[10px] text-neutral-500 mb-1">Position</label>
                            <input type="range" min="0" max="1" step="0.01" data-param="position" class="param-slider">
                            <span class="text-[10px] text-emerald-400 font-mono">0.00</span>
                        </div>
                        <!-- ... More sliders ... -->
                        <div class="knob-container col-span-2">
                            <label class="text-[10px] text-neutral-500 mb-1">Density</label>
                            <input type="range" min="1" max="50" step="1" data-param="density" class="param-slider">
                            <span class="text-[10px] text-emerald-400 font-mono">10hz</span>
                        </div>
                         <div class="knob-container col-span-2">
                            <label class="text-[10px] text-neutral-500 mb-1">Pitch</label>
                            <input type="range" min="0.1" max="4.0" step="0.01" data-param="pitch" class="param-slider">
                            <span class="text-[10px] text-emerald-400 font-mono">1.00x</span>
                        </div>
                    </div>
                </div>

                <!-- 909 Controls -->
                <div id="simpleDrumControls" class="hidden space-y-6">
                    <h3 class="text-xs font-bold text-orange-400 uppercase">909 Engine</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="knob-container">
                            <label class="text-[10px] text-neutral-500 mb-2">Tuning</label>
                            <input type="range" min="0" max="1" step="0.01" data-param="drumTune" class="param-slider">
                        </div>
                        <div class="knob-container">
                            <label class="text-[10px] text-neutral-500 mb-2">Decay</label>
                            <input type="range" min="0" max="1" step="0.01" data-param="drumDecay" class="param-slider">
                        </div>
                    </div>
                </div>

                <!-- Automation Controls -->
                <div id="automationControls" class="hidden">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase">Automation</h3>
                    <!-- ... -->
                </div>

                <!-- LFO Section -->
                <div id="lfoSection" class="pt-4 border-t border-neutral-800">
                    <div id="lfoTabsContainer" class="flex gap-1 mb-2"></div>
                    <div class="bg-neutral-800/30 p-3 rounded border border-neutral-800 space-y-3">
                        <div class="flex gap-2">
                             <select id="lfoTarget" class="w-full bg-neutral-800 text-neutral-300 text-[10px] rounded border border-neutral-700 p-1"></select>
                             <select id="lfoWave" class="w-full bg-neutral-800 text-neutral-300 text-[10px] rounded border border-neutral-700 p-1"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="knob-container">
                                <label class="text-[10px] text-neutral-500">Rate</label>
                                <input type="range" id="lfoRate" min="0.1" max="20" step="0.1">
                                <span id="lfoRateVal" class="text-[10px] text-emerald-500"></span>
                            </div>
                            <div class="knob-container">
                                <label class="text-[10px] text-neutral-500">Amount</label>
                                <input type="range" id="lfoAmt" min="0" max="1" step="0.01">
                                <span id="lfoAmtVal" class="text-[10px] text-emerald-500"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="trackLibraryModal" class="hidden"></div> <!-- Placeholder for modal component if needed -->

    <!-- Load the new module-based app -->
    <script type="module" src="js/app.js"></script>
</body>
</html>